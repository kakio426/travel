<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 ê°•ë¦‰ ê°€ì¡± ì—¬í–‰ í”Œë˜ë„ˆ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts (Noto Sans KR) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f3f4f6;
        }
        /* íƒ€ì„ë¼ì¸ ë ˆì´ì•„ì›ƒ ìˆ˜ì •: ì ê³¼ ì‹œê°„ì´ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ê°„ê²© í™•ë³´ */
        .timeline-line {
            position: absolute;
            left: 60px; 
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #e5e7eb;
            z-index: 0;
        }
        .timeline-dot {
            z-index: 10;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer; /* Clickable indicator */
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .mission-pulse {
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        /* Hide scrollbar for clean modal */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Chat UI Styles */
        .chat-bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        .chat-user {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-ai {
            background-color: #f3f4f6;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid #e5e7eb;
        }
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        /* Markdown Styles in Chat */
        .chat-ai p { margin-bottom: 0.5em; }
        .chat-ai p:last-child { margin-bottom: 0; }
        .chat-ai strong { font-weight: 600; color: #1d4ed8; }
        .chat-ai ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
    </style>
</head>
<body class="text-gray-800">

    <!-- App Container -->
    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-xl overflow-hidden relative">
        
        <!-- Header -->
        <header class="bg-blue-600 text-white p-6 rounded-b-3xl shadow-lg relative z-20">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-bold mb-1">ê°•ë¦‰ ê°€ì¡± íë§ ì—¬í–‰</h1>
                    <p class="text-blue-100 text-sm"><i class="far fa-calendar-alt mr-1"></i> 2026.01.07 - 01.08</p>
                </div>
                <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                    <span class="block text-xs text-center text-blue-50">D-Day</span>
                    <span class="block text-xl font-bold text-center">GO</span>
                </div>
            </div>
            
            <!-- Family Tags -->
            <div class="flex gap-2 mt-4 overflow-x-auto no-scrollbar">
                <span class="px-3 py-1 bg-blue-500 rounded-full text-xs font-medium whitespace-nowrap">ğŸ‘¨ ì•„ë¹ : ì»¤í”¼ëŸ¬ë²„</span>
                <span class="px-3 py-1 bg-pink-500 rounded-full text-xs font-medium whitespace-nowrap">ğŸ‘© ì—„ë§ˆ: í† ì†ì…ë§›</span>
                <span class="px-3 py-1 bg-yellow-500 rounded-full text-xs font-medium whitespace-nowrap">ğŸ‘§ 6ì„¸ ë”¸: ë™ë¬¼/ì•¡í‹°ë¹„í‹°</span>
            </div>
        </header>

        <!-- Day Tabs -->
        <div class="flex justify-center mt-4 px-4 gap-4 sticky top-0 z-30 bg-white/90 backdrop-blur-md py-2 border-b border-gray-100">
            <button onclick="switchDay(0)" id="tab-day1" class="flex-1 py-2 px-4 rounded-xl font-bold text-sm transition-all bg-blue-600 text-white shadow-md transform scale-105">
                Day 1 (í™”)
            </button>
            <button onclick="switchDay(1)" id="tab-day2" class="flex-1 py-2 px-4 rounded-xl font-bold text-sm transition-all bg-gray-100 text-gray-500 hover:bg-gray-200">
                Day 2 (ìˆ˜)
            </button>
        </div>

        <!-- Timeline Content -->
        <div id="timeline-container" class="p-6 relative pb-24">
            <!-- Content injected by JS -->
        </div>

        <!-- Floating Action Buttons -->
        <div class="fixed bottom-6 right-6 z-40 flex flex-col gap-3 pointer-events-none">
            
            <!-- Add Schedule Button -->
            <div class="pointer-events-auto self-end">
                <button onclick="openAddModal()" class="bg-emerald-500 text-white p-4 rounded-full shadow-2xl hover:bg-emerald-600 transition-colors flex items-center justify-center w-14 h-14" title="ë‚˜ë§Œì˜ ì¼ì • ì¶”ê°€">
                    <i class="fas fa-plus text-xl"></i>
                </button>
            </div>

            <!-- Summary Button -->
            <div class="pointer-events-auto self-end">
                <button onclick="showTotalSummary()" class="bg-gray-800 text-white p-4 rounded-full shadow-2xl hover:bg-gray-700 transition-colors flex items-center justify-center w-14 h-14" title="ì „ì²´ ì¼ì • ìš”ì•½">
                    <i class="fas fa-list-check text-xl"></i>
                </button>
            </div>

            <!-- AI Chat Button -->
            <div class="pointer-events-auto self-end relative">
                <span class="absolute -top-1 -right-1 flex h-4 w-4">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-4 w-4 bg-blue-500"></span>
                </span>
                <button onclick="toggleChat()" class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 rounded-full shadow-2xl hover:from-blue-600 hover:to-indigo-700 transition-all flex items-center justify-center w-14 h-14 border-2 border-white" title="AI ì—¬í–‰ ë¹„ì„œ">
                    <i class="fas fa-sparkles text-xl"></i>
                </button>
            </div>
        </div>

    </div>

    <!-- Option Selection Modal -->
    <div id="option-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 max-w-md mx-auto transform transition-transform duration-300 translate-y-full" id="modal-content">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6"></div>
            <h3 class="text-xl font-bold mb-2">ì–´ë””ë¡œ ê°ˆê¹Œìš”?</h3>
            <p class="text-sm text-gray-500 mb-4">ê°€ì¡±ì˜ ì»¨ë””ì…˜ì— ë§ì¶° ì„ íƒí•´ ë³´ì„¸ìš”.</p>
            
            <div id="modal-options-list" class="space-y-3 max-h-[60vh] overflow-y-auto no-scrollbar pb-8">
                <!-- Options injected here -->
            </div>
            
            <button onclick="closeModal()" class="w-full mt-4 bg-gray-100 py-3 rounded-xl font-bold text-gray-600">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- Add Schedule Modal -->
    <div id="add-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeAddModal()"></div>
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm relative z-10">
            <h3 class="text-xl font-bold mb-4">âœ¨ ë‚˜ë§Œì˜ ì¼ì • ì¶”ê°€</h3>
            <p class="text-xs text-gray-500 mb-4">êµ¬ê¸€ ì‹œíŠ¸ë‚˜ ê²€ìƒ‰í•œ ë§›ì§‘ ì •ë³´ë¥¼ ì§ì ‘ ì…ë ¥í•´ë³´ì„¸ìš”.</p>
            
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì‹œê°„</label>
                    <input type="time" id="new-time" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì¥ì†Œëª…</label>
                    <input type="text" id="new-title" placeholder="ì˜ˆ: ìˆ¨ê²¨ì§„ ë§›ì§‘" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì„¤ëª…</label>
                    <input type="text" id="new-desc" placeholder="ê°„ë‹¨í•œ ì„¤ëª…" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì¹´í…Œê³ ë¦¬</label>
                    <select id="new-category" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                        <option value="meal">ì‹ì‚¬</option>
                        <option value="coffee">ì¹´í˜/ë””ì €íŠ¸</option>
                        <option value="activity">ì•¡í‹°ë¹„í‹°/ê´€ê´‘</option>
                        <option value="shopping">ì‡¼í•‘</option>
                        <option value="etc">ê¸°íƒ€</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                    <input type="text" id="new-tags" placeholder="ì˜ˆ: ì¶”ì²œ, í•«í”Œ" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm">
                </div>
            </div>

            <button onclick="addNewSchedule()" class="w-full mt-6 bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-xl font-bold transition-colors">ì¶”ê°€í•˜ê¸°</button>
            <button onclick="closeAddModal()" class="w-full mt-2 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- Summary Modal -->
    <div id="summary-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSummary()"></div>
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm relative z-10 max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 border-b pb-2">ğŸ“‹ ìµœì¢… ì—¬í–‰ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
            <div id="summary-content" class="text-sm space-y-4"></div>
            <button onclick="closeSummary()" class="w-full mt-6 bg-blue-600 text-white py-3 rounded-xl font-bold">í™•ì¸ ì™„ë£Œ</button>
        </div>
    </div>

    <!-- AI Tip Modal -->
    <div id="ai-tip-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeAiTip()"></div>
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm relative z-10 transform transition-all scale-95 opacity-0" id="ai-tip-content">
            <div class="flex items-center gap-2 mb-3">
                <i class="fas fa-lightbulb text-yellow-500 text-xl"></i>
                <h3 class="text-lg font-bold text-gray-800">AI ê¿€íŒ</h3>
            </div>
            <div id="ai-tip-text" class="text-gray-600 text-sm leading-relaxed min-h-[60px] flex items-center justify-center">
                <!-- Tip Content -->
            </div>
            <button onclick="closeAiTip()" class="w-full mt-4 bg-gray-100 hover:bg-gray-200 text-gray-800 py-2.5 rounded-xl font-bold transition-colors">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- AI Chat Interface -->
    <div id="chat-interface" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="toggleChat()"></div>
        <div class="absolute bottom-0 right-0 w-full sm:w-[400px] h-[85vh] sm:h-[600px] bg-white sm:rounded-tl-3xl sm:rounded-tr-3xl shadow-2xl flex flex-col transform transition-transform duration-300 translate-y-full" id="chat-window">
            
            <!-- Chat Header -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 rounded-t-none sm:rounded-t-3xl flex justify-between items-center text-white">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-md">
                        <i class="fas fa-robot text-lg"></i>
                    </div>
                    <div>
                        <h3 class="font-bold">AI ì—¬í–‰ ë¹„ì„œ</h3>
                        <p class="text-xs text-blue-100">ê°•ë¦‰ ì—¬í–‰ ì „ë¬¸ê°€ Gemini</p>
                    </div>
                </div>
                <button onclick="toggleChat()" class="text-white/80 hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2 bg-gray-50">
                <div class="chat-ai chat-bubble shadow-sm">
                    ì•ˆë…•í•˜ì„¸ìš”! ê°•ë¦‰ ì—¬í–‰ ì „ë¬¸ê°€ AI ë¹„ì„œì…ë‹ˆë‹¤. ğŸ¤–<br>
                    ì‘ì„±í•˜ì‹  1ë°• 2ì¼ ì—¬í–‰ ê³„íšì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹ ê°€ìš”?<br>
                    ë§›ì§‘ ì¶”ì²œì´ë‚˜ ì´ë™ ê²½ë¡œ, ì•„ì´ë¥¼ ìœ„í•œ íŒ ë“± ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”!
                </div>
            </div>

            <!-- Chat Input -->
            <div class="p-4 bg-white border-t border-gray-100">
                <div class="relative flex items-center gap-2">
                    <input type="text" id="chat-input" placeholder="ê¶ê¸ˆí•œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                           class="w-full bg-gray-100 border-0 rounded-full px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all text-sm"
                           onkeypress="handleChatKey(event)">
                    <button onclick="sendMessage()" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center transition-colors shadow-md">
                        <i class="fas fa-paper-plane text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 0. Gemini API Configuration ---
        const apiKey = "AIzaSyCQXaRbYgQ5YeQj8rMnHPrP9t2W8zTST1U"; // API Key will be injected by the environment

        // --- 1. JSON Data Structure ---
        const tripData = {
            "tripInfo": {
                "title": "2026 ê°•ë¦‰ ê°€ì¡± íë§ ì—¬í–‰",
                "dates": "2026-01-07 ~ 2026-01-08",
                "stay": "ì‹ ë¼ ëª¨ë…¸ê·¸ë¨ ê°•ë¦‰",
                "family": "ì•„ë¹ (ì»¤í”¼), ì—„ë§ˆ(í† ì†ìŒì‹), 6ì„¸ ë”¸(ë™ë¬¼/ì•¡í‹°ë¹„í‹°)"
            },
            "itinerary": [
                {
                    "day": 1,
                    "date": "1ì›” 7ì¼ (í™”)",
                    "schedule": [
                        {
                            "id": "d1-lunch",
                            "time": "12:00",
                            "category": "meal",
                            "isFixed": true,
                            "mission": false,
                            "selectedOptionIndex": 0,
                            "options": [
                                {
                                    "title": "ì´ˆë‹¹ ìˆœë‘ë¶€ ë§ˆì„",
                                    "desc": "ì—„ë§ˆëŠ” ì–¼í° ì „ê³¨, ë”¸ì€ í•˜ì–€ ìˆœë‘ë¶€",
                                    "tags": ["í† ì†ì ", "ì•„ì´ì¶”ì²œ"],
                                    "place": "ì°¨í˜„í¬ìˆœë‘ë¶€ or ì´ˆë‹¹í• ë¨¸ë‹ˆìˆœë‘ë¶€"
                                }
                            ]
                        },
                        {
                            "id": "d1-snack",
                            "time": "13:30",
                            "category": "shopping",
                            "isFixed": true,
                            "mission": true,
                            "selectedOptionIndex": 0,
                            "options": [
                                {
                                    "title": "ê°•ë¦‰ìƒŒë“œ ì´ˆë‹¹ì§ì˜ì ",
                                    "desc": "âš ï¸ í’ˆì ˆ ë°©ì§€! ë³´ì´ë©´ ë¬´ì¡°ê±´ ë¯¸ë¦¬ êµ¬ë§¤",
                                    "tags": ["ë¯¸ì…˜í•„ìˆ˜", "ì„ ë¬¼"],
                                    "place": "ì´ˆë‹¹ë™ ì§ì˜ì "
                                }
                            ]
                        },
                        {
                            "id": "d1-coffee",
                            "time": "14:00",
                            "category": "coffee",
                            "isFixed": false,
                            "mission": false,
                            "selectedOptionIndex": 0,
                            "options": [
                                { "title": "ë³´í—¤ë¯¸ì•ˆ ë°•ì´ì¶” ì»¤í”¼", "desc": "ëŒ€í•œë¯¼êµ­ 1ì„¸ëŒ€ ëª…ì¥ì˜ í•¸ë“œë“œë¦½", "tags": ["ì•„ë¹ ì¶”ì²œ", "ì¥ì¸ì •ì‹ "] },
                                { "title": "ë°”ìš°ì¹´í˜ (ë³¸ì )", "desc": "íˆ‡ë§ˆë£¨ ì–´ë¨¸ë‹ˆ ìš´ì˜, ëŒ€ê¸° ì—†ëŠ” í‘ì„ìë¼ë–¼", "tags": ["ì›¨ì´íŒ…ì—†ìŒ", "ì‹œê·¸ë‹ˆì²˜"] },
                                { "title": "ì¹´í˜ ê¸°ì™€", "desc": "ê³ ì¦ˆë„‰í•œ í•œì˜¥ ê°ì„±", "tags": ["ì—„ë§ˆì¶”ì²œ", "ë¶„ìœ„ê¸°"] },
                                { "title": "ì—”ë“œíˆ¬ì•¤ë“œ", "desc": "ì•„ì´ê°€ ë›°ì–´ë†€ê¸° ì¢‹ì€ ë„“ì€ ì •ì›", "tags": ["ì•„ì´ì¶”ì²œ", "ëŒ€í˜•ì¹´í˜"] },
                                { "title": "í¼ë² ì´ë“œ", "desc": "ë§›ìˆëŠ” ë¹µê³¼ ì„¸ë ¨ëœ í†µì°½ ë·°", "tags": ["ë² ì´ì»¤ë¦¬", "ì‚¬ì§„ë§›ì§‘"] }
                            ]
                        },
                        {
                            "id": "d1-checkin",
                            "time": "16:00",
                            "category": "stay",
                            "isFixed": true,
                            "mission": false,
                            "selectedOptionIndex": 0,
                            "options": [
                                {
                                    "title": "ì‹ ë¼ ëª¨ë…¸ê·¸ë¨ ì²´í¬ì¸",
                                    "desc": "ì˜¨ìˆ˜í’€ ìˆ˜ì˜ (3ë¶€ 15:00~ ì´ìš© ì¶”ì²œ)",
                                    "tags": ["í˜¸í…”", "ìˆ˜ì˜"],
                                    "place": "ì†¡ì •ë™"
                                }
                            ]
                        },
                        {
                            "id": "d1-market",
                            "time": "18:30",
                            "category": "activity",
                            "isFixed": true,
                            "mission": true,
                            "selectedOptionIndex": 0,
                            "options": [
                                {
                                    "title": "ê°•ë¦‰ ì¤‘ì•™ì‹œì¥",
                                    "desc": "ë² ë‹ˆë‹­ê°•ì •, ì–´ë¬µê³ ë¡œì¼€, í˜¸ë–¡ í•„ìˆ˜",
                                    "tags": ["ì‹œì¥êµ¬ê²½", "ë¯¸ì…˜í•„ìˆ˜"],
                                    "place": "ì„±ë‚¨ë™"
                                }
                            ]
                        },
                        {
                            "id": "d1-dinner",
                            "time": "19:30",
                            "category": "meal",
                            "isFixed": false,
                            "mission": false,
                            "selectedOptionIndex": 0,
                            "options": [
                                { "title": "ê´‘ë•ì‹ë‹¹", "desc": "70ë…„ ì „í†µ ì†Œë¨¸ë¦¬êµ­ë°¥ (ì•„ì´: ë§‘ì€êµ­ë¬¼)", "tags": ["í† ì†ì ", "ì•„ì´ì‹ì‚¬"] },
                                { "title": "ê°ììœ ì›ì§€", "desc": "ê°ì ì˜¹ì‹¬ì´, ê°ìë­‰ì¹˜êµ¬ì´ ë“± ì´ìƒ‰ ë§›ì§‘", "tags": ["íŠ¸ë Œë””", "í† ì†í“¨ì „"] },
                                { "title": "ì •í™”ì‹ë‹¹", "desc": "ë§µì§€ ì•Šì€ ìƒì„ êµ¬ì´ì™€ ì˜¤ì§•ì–´ë³¶ìŒ", "tags": ["í˜„ì§€ì¸", "ë°±ë°˜"] },
                                { "title": "í•´ì„±íšŸì§‘", "desc": "ì‹œì¥ ë‚´ ì•Œíƒ•/ì§€ë¦¬íƒ• ë…¸í¬", "tags": ["ì‹œì¥ë§›ì§‘", "í•´ì¥"] },
                                { "title": "ì†Œë¨¸ë¦¬êµ­ë°¥ ê³¨ëª©", "desc": "ì‹œì¥ ë¶„ìœ„ê¸°ë¥¼ ëŠë¼ë©° ë“ ë“ í•œ í•œ ë¼", "tags": ["ê°€ì„±ë¹„", "ëœ¨ëˆí•¨"] }
                            ]
                        }
                    ]
                },
                {
                    "day": 2,
                    "date": "1ì›” 8ì¼ (ìˆ˜)",
                    "schedule": [
                        {
                            "id": "d2-activity",
                            "time": "10:00",
                            "category": "activity",
                            "isFixed": false,
                            "mission": false,
                            "selectedOptionIndex": 0,
                            "options": [
                                { "title": "ìì—°ì•„ë†€ì", "desc": "ì‹¤ë‚´ ìƒíƒœì²´í—˜, ë™ë¬¼ ë¨¹ì´ì£¼ê¸° (ê²¨ìš¸ ì¶”ì²œ 1ìœ„)", "tags": ["ì•„ì´ìµœì• ", "ì‹¤ë‚´"] },
                                { "title": "ê²½í¬ ì•„ì¿ ì•„ë¦¬ì›€", "desc": "ë”°ëœ»í•œ ì‹¤ë‚´ì—ì„œ ìˆ˜ë‹¬ê³¼ í­ê·„ ê´€ëŒ", "tags": ["ì‹¤ë‚´", "êµìœ¡ì "] },
                                { "title": "ì•„ë¥´ë–¼ë®¤ì§€ì—„", "desc": "í™”ë ¤í•œ ë¯¸ë””ì–´ì•„íŠ¸ì™€ ì²´í—˜", "tags": ["ì‚¬ì§„ë§›ì§‘", "ê°€ì¡±"] },
                                { "title": "ìŒë‘¥ì´ ë™ë¬¼ë†ì¥", "desc": "ì‹¤ë‚´ ì²´í—˜ë™ì´ ë§ì€ ëŒ€í˜• ë™ë¬¼ë†ì¥", "tags": ["ë¨¹ì´ì²´í—˜", "ë‹¤ì–‘í•¨"] },
                                { "title": "ëŸ°ë‹ë§¨ ê°•ë¦‰ì ", "desc": "ì—ë„ˆì§€ ë°œì‚°! ì‹¤ë‚´ ë¯¸ì…˜ ê²Œì„", "tags": ["ì•¡í‹°ë¹„í‹°", "í™œë™ì "] }
                            ]
                        },
                        {
                            "id": "d2-lunch",
                            "time": "12:30",
                            "category": "meal",
                            "isFixed": false,
                            "mission": false,
                            "selectedOptionIndex": 0,
                            "options": [
                                { "title": "í¬ë‚¨ì‚¬ê³¨ì˜¹ì‹¬ì´", "desc": "ì™€ì´í”„ ê°•ë ¥ ì¶”ì²œ! ì•ˆ ë§¤ìš´ ì«€ë“ ì˜¹ì‹¬ì´", "tags": ["í† ì†ì ", "ì•ˆë§¤ì›€"] },
                                { "title": "ê°•ë¦‰ ë¶ˆê³ ê¸°", "desc": "ë‹¬ì½¤ íŒŒë¶ˆê³ ê¸° & í† ì† ëœì¥ì°Œê°œ", "tags": ["ì•„ì´ë°¥ë„ë‘‘", "ê°€ì¡±ì‹ì‚¬"] },
                                { "title": "ì£¼ë¬¸ì§„ ìƒì„ êµ¬ì´", "desc": "ìˆ¯ë¶ˆí–¥ ê°€ë“í•œ ëª¨ë“¬ ìƒì„ êµ¬ì´", "tags": ["ê±´ê°•ì‹", "ë“ ë“ í•¨"] },
                                { "title": "ë¯¼ì†ì˜¹ì‹¬ì´ë§‰êµ­ìˆ˜", "desc": "ì˜¹ì‹¬ì´ì™€ ìˆ˜ìœ¡ì˜ ì™„ë²½í•œ ì¡°í™”", "tags": ["í˜„ì§€ì¸", "ìˆ˜ìœ¡"] },
                                { "title": "ë©”ì‹œ56", "desc": "í•«í•œ í”„ë¦¬ë¯¸ì—„ í•´ì‚°ë¬¼ ë®ë°¥ (ì¹´ì´ì„¼ë™)", "tags": ["í•«í”Œ", "ì¼ì‹"] },
                                { "title": "ë¦¬í‹€ë‹¤ì´ë„ˆ", "desc": "ë¯¸êµ­ ê°ì„± íŒ¬ì¼€ì´í¬ ë²„ê±°", "tags": ["ì•„ì´ì·¨í–¥", "ì´ìƒ‰"] },
                                { "title": "ê°ììœ ì›ì§€ ì‹ë‹¹", "desc": "ê°ììˆ˜í”„ì™€ ì¥ì¹¼êµ­ìˆ˜ì˜ ì¡°í™”", "tags": ["ê°ììš”ë¦¬", "í™í•¨"] }
                            ]
                        },
                        {
                            "id": "d2-coffee",
                            "time": "14:30",
                            "category": "coffee",
                            "isFixed": false,
                            "mission": false,
                            "selectedOptionIndex": 1, 
                            "options": [
                                { "title": "í…Œë¼ë¡œì‚¬ ë³¸ì ", "desc": "ì›…ì¥í•œ ì»¤í”¼ ê³µì¥, ì»¤í”¼ ë§›ì˜ ì •ìˆ˜", "tags": ["ì•„ë¹ í•„ìˆ˜", "ì›…ì¥í•¨"] },
                                { "title": "í…Œë¼ë¡œì‚¬ ê²½í¬í˜¸ìˆ˜", "desc": "ì–´ë¦°ì´ ë„ì„œê´€ ë³´ìœ , í˜¸ìˆ˜ ë·° ë¶ì¹´í˜", "tags": ["ì•„ì´ë™ë°˜", "ì—¬ìœ "] },
                                { "title": "ì»¤í”¼ì»¤í¼ ë°•ë¬¼ê´€", "desc": "ì»¤í”¼ ì—­ì‚¬ ê²¬í•™ ë° ì²´í—˜", "tags": ["êµìœ¡ì ", "ì²´í—˜"] },
                                { "title": "í—ˆê· Â·í—ˆë‚œì„¤í—Œ ê³µì›", "desc": "ê³ ì¦ˆë„‰í•œ ê²¨ìš¸ ì†”ë°­ ì‚°ì±…", "tags": ["ì—„ë§ˆì¶”ì²œ", "íë§"] },
                                { "title": "í•˜ìŠ¬ë¼ ì•„íŠ¸ì›”ë“œ", "desc": "ë°”ë‹¤ ì ˆë²½ ìœ„ ì˜ˆìˆ  ì¡°ê° ê³µì›", "tags": ["í¬í† ì¡´", "ì˜ˆìˆ "] },
                                { "title": "ì•ˆëª© ì»¤í”¼ê±°ë¦¬", "desc": "ë°”ë‹¤ë¥¼ ë³´ë©° ë§ˆì‹œëŠ” ë§ˆì§€ë§‰ ì»¤í”¼", "tags": ["ì˜¤ì…˜ë·°", "í´ë˜ì‹"] },
                                { "title": "ê°•ë¦‰ ì†”í–¥ìˆ˜ëª©ì›", "desc": "í”¼í†¤ì¹˜ë“œ ê°€ë“í•œ ìˆ² ì‚°ì±…", "tags": ["ìì—°", "ì‚°ì±…"] }
                            ]
                        },
                        {
                            "id": "d2-home",
                            "time": "16:30",
                            "category": "etc",
                            "isFixed": true,
                            "mission": false,
                            "selectedOptionIndex": 0,
                            "options": [
                                {
                                    "title": "ê°•ë¦‰ ì¶œë°œ (ê·€ê°€)",
                                    "desc": "ì•ˆì „ ìš´ì „ í•˜ì„¸ìš”!",
                                    "tags": ["ì—¬í–‰ì¢…ë£Œ"],
                                    "place": "ì§‘ìœ¼ë¡œ"
                                }
                            ]
                        }
                    ]
                }
            ]
        };

        // --- 2. Application Logic ---
        let currentDayIdx = 0;

        function init() {
            renderTimeline();
        }

        function switchDay(index) {
            currentDayIdx = index;
            // Update Tab Styles
            const tab1 = document.getElementById('tab-day1');
            const tab2 = document.getElementById('tab-day2');
            
            if (index === 0) {
                tab1.className = "flex-1 py-2 px-4 rounded-xl font-bold text-sm transition-all bg-blue-600 text-white shadow-md transform scale-105";
                tab2.className = "flex-1 py-2 px-4 rounded-xl font-bold text-sm transition-all bg-gray-100 text-gray-500 hover:bg-gray-200";
            } else {
                tab1.className = "flex-1 py-2 px-4 rounded-xl font-bold text-sm transition-all bg-gray-100 text-gray-500 hover:bg-gray-200";
                tab2.className = "flex-1 py-2 px-4 rounded-xl font-bold text-sm transition-all bg-blue-600 text-white shadow-md transform scale-105";
            }
            renderTimeline();
        }

        function getCategoryIcon(category) {
            switch(category) {
                case 'meal': return '<i class="fas fa-utensils"></i>';
                case 'coffee': return '<i class="fas fa-mug-hot"></i>';
                case 'activity': return '<i class="fas fa-child-reaching"></i>';
                case 'shopping': return '<i class="fas fa-bag-shopping"></i>';
                case 'stay': return '<i class="fas fa-bed"></i>';
                default: return '<i class="fas fa-map-pin"></i>';
            }
        }

        function getCategoryColor(category) {
            switch(category) {
                case 'meal': return 'bg-orange-100 text-orange-600';
                case 'coffee': return 'bg-amber-100 text-amber-700';
                case 'activity': return 'bg-green-100 text-green-600';
                case 'shopping': return 'bg-pink-100 text-pink-600';
                case 'stay': return 'bg-indigo-100 text-indigo-600';
                default: return 'bg-gray-100 text-gray-600';
            }
        }

        function openNaverSearch(title) {
            const query = encodeURIComponent(title);
            window.open(`https://search.naver.com/search.naver?query=${query}`, '_blank');
        }

        function renderTimeline() {
            const container = document.getElementById('timeline-container');
            const dayData = tripData.itinerary[currentDayIdx];
            
            // Sort by time
            dayData.schedule.sort((a, b) => a.time.localeCompare(b.time));

            let html = `<div class="timeline-line"></div>`; // Vertical Line

            dayData.schedule.forEach((item, index) => {
                const selected = item.options[item.selectedOptionIndex];
                const isLast = index === dayData.schedule.length - 1;
                const missionClass = item.mission ? "mission-pulse border-red-200 border-2" : "border-transparent";

                html += `
                <div class="relative pl-20 pb-8 ${isLast ? '' : ''}"> <!-- Increased padding-left to 20 -->
                    <!-- Dot -->
                    <div class="absolute left-[53px] top-1 w-4 h-4 bg-white border-4 border-blue-500 rounded-full timeline-dot shadow-sm"></div> <!-- Moved dot to align with line -->
                    
                    <!-- Time -->
                    <span class="absolute left-0 top-0 text-xs font-bold text-gray-400 w-12 text-right">${item.time}</span> <!-- Adjusted time position -->

                    <!-- Card (Clickable) -->
                    <div class="glass-card rounded-2xl p-4 shadow-sm hover:shadow-md transition-shadow ${missionClass}" 
                         onclick="openNaverSearch('${selected.title}')" 
                         title="ë„¤ì´ë²„ì—ì„œ '${selected.title}' ê²€ìƒ‰í•˜ê¸°">
                        
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-2">
                                <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm ${getCategoryColor(item.category)}">
                                    ${getCategoryIcon(item.category)}
                                </span>
                                <div>
                                    <h3 class="font-bold text-lg leading-tight text-gray-800">
                                        ${selected.title} 
                                        <i class="fas fa-search text-[10px] text-gray-300 ml-1"></i>
                                    </h3>
                                    ${selected.place ? `<p class="text-xs text-gray-400 mt-0.5"><i class="fas fa-map-marker-alt mr-1"></i>${selected.place}</p>` : ''}
                                </div>
                            </div>
                            ${!item.isFixed ? 
                                `<button onclick="event.stopPropagation(); openModal('${item.id}')" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 py-1 rounded-lg transition-colors">
                                    <i class="fas fa-exchange-alt mr-1"></i>ë³€ê²½
                                </button>` : ''}
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-3">${selected.desc}</p>
                        
                        <div class="flex flex-wrap gap-1 mb-3">
                            ${selected.tags.map(tag => {
                                let colorClass = "bg-gray-100 text-gray-500";
                                if(tag.includes("ì•„ë¹ ")) colorClass = "bg-blue-100 text-blue-600";
                                if(tag.includes("ì—„ë§ˆ") || tag.includes("í† ì†")) colorClass = "bg-pink-100 text-pink-600";
                                if(tag.includes("ì•„ì´") || tag.includes("ë”¸")) colorClass = "bg-yellow-100 text-yellow-700";
                                if(tag.includes("ë¯¸ì…˜")) colorClass = "bg-red-100 text-red-600 font-bold";
                                return `<span class="text-[10px] px-2 py-0.5 rounded-md ${colorClass}">#${tag}</span>`;
                            }).join('')}
                        </div>
                        
                        <!-- AI Tip Button -->
                        <button onclick="event.stopPropagation(); getAiTip('${selected.title}', '${selected.desc}')" class="w-full text-xs bg-gradient-to-r from-indigo-50 to-blue-50 hover:from-indigo-100 hover:to-blue-100 text-indigo-600 py-2 rounded-lg transition-all border border-indigo-100 flex items-center justify-center gap-1 group">
                            <i class="fas fa-magic group-hover:animate-pulse"></i> <span>Gemini AI ê¿€íŒ ë³´ê¸°</span>
                        </button>
                        
                        ${item.mission ? 
                            `<div class="mt-3 bg-red-50 text-red-600 text-xs px-3 py-2 rounded-lg flex items-center gap-2">
                                <i class="fas fa-exclamation-circle"></i>
                                <span><strong>í•„ìˆ˜ ë¯¸ì…˜:</strong> ìŠì§€ ë§ê³  ê¼­ ì±™ê¸°ì„¸ìš”!</span>
                            </div>` : ''}
                    </div>
                </div>
                `;
            });

            container.innerHTML = html;
        }

        // --- 3. Modal Logic ---
        let currentEditId = null;

        function openModal(scheduleId) {
            currentEditId = scheduleId;
            const dayData = tripData.itinerary[currentDayIdx];
            const scheduleItem = dayData.schedule.find(item => item.id === scheduleId);
            const modalList = document.getElementById('modal-options-list');
            
            let html = '';
            scheduleItem.options.forEach((opt, idx) => {
                const isSelected = idx === scheduleItem.selectedOptionIndex;
                const borderClass = isSelected ? "border-blue-500 ring-1 ring-blue-500 bg-blue-50" : "border-gray-200 hover:border-blue-300";
                
                html += `
                <div onclick="selectOption(${idx})" class="cursor-pointer border rounded-xl p-4 transition-all ${borderClass}">
                    <div class="flex justify-between items-center mb-1">
                        <h4 class="font-bold ${isSelected ? 'text-blue-700' : 'text-gray-800'}">${opt.title}</h4>
                        ${isSelected ? '<i class="fas fa-check-circle text-blue-500"></i>' : ''}
                    </div>
                    <p class="text-xs text-gray-500 mb-2">${opt.desc}</p>
                    <div class="flex gap-1 flex-wrap">
                         ${opt.tags.map(tag => `<span class="text-[10px] bg-white border border-gray-100 px-1.5 py-0.5 rounded text-gray-400">#${tag}</span>`).join('')}
                    </div>
                </div>
                `;
            });

            modalList.innerHTML = html;
            
            const modal = document.getElementById('option-modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('translate-y-full');
            }, 10);
        }

        function selectOption(optionIndex) {
            const dayData = tripData.itinerary[currentDayIdx];
            const scheduleItem = dayData.schedule.find(item => item.id === currentEditId);
            
            scheduleItem.selectedOptionIndex = optionIndex;
            closeModal();
            renderTimeline();
        }

        function closeModal() {
            const modal = document.getElementById('option-modal');
            const content = document.getElementById('modal-content');
            content.classList.add('translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // --- 4. Add Schedule Logic ---
        function openAddModal() {
            document.getElementById('add-modal').classList.remove('hidden');
            // Set default time to now or something reasonable
            document.getElementById('new-time').value = "15:00";
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.add('hidden');
        }

        function addNewSchedule() {
            const time = document.getElementById('new-time').value;
            const title = document.getElementById('new-title').value;
            const desc = document.getElementById('new-desc').value;
            const category = document.getElementById('new-category').value;
            const tagsStr = document.getElementById('new-tags').value;
            
            if(!title) {
                alert("ì¥ì†Œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const tags = tagsStr.split(',').map(t => t.trim()).filter(t => t !== "");
            const newId = `custom-${Date.now()}`;

            const newItem = {
                "id": newId,
                "time": time,
                "category": category,
                "isFixed": true, // Custom items are fixed by default (no alternatives unless added logic)
                "mission": false,
                "selectedOptionIndex": 0,
                "options": [
                    {
                        "title": title,
                        "desc": desc,
                        "tags": tags.length > 0 ? tags : ["ë‚˜ë§Œì˜ì¥ì†Œ"],
                        "place": "ì§ì ‘ ì¶”ê°€í•¨"
                    }
                ]
            };

            // Add to current day schedule
            tripData.itinerary[currentDayIdx].schedule.push(newItem);
            
            // Re-render
            closeAddModal();
            renderTimeline();

            // Reset Form
            document.getElementById('new-title').value = "";
            document.getElementById('new-desc').value = "";
            document.getElementById('new-tags').value = "";
        }

        // --- 5. Summary Logic ---
        function showTotalSummary() {
            const modal = document.getElementById('summary-modal');
            const content = document.getElementById('summary-content');
            let html = '';

            tripData.itinerary.forEach(day => {
                html += `<div class="font-bold text-blue-600 mt-2 mb-1">${day.date}</div><ul class="list-disc pl-5 space-y-1 text-gray-600">`;
                // Ensure sorted for summary
                const sortedSchedule = [...day.schedule].sort((a,b) => a.time.localeCompare(b.time));
                sortedSchedule.forEach(item => {
                    const sel = item.options[item.selectedOptionIndex];
                    html += `<li><span class="font-medium text-gray-800">${sel.title}</span> <span class="text-xs text-gray-400">(${item.time})</span></li>`;
                });
                html += `</ul>`;
            });

            content.innerHTML = html;
            modal.classList.remove('hidden');
        }

        function closeSummary() {
            document.getElementById('summary-modal').classList.add('hidden');
        }

        // --- 6. Gemini AI Logic ---

        // 6.1 AI Tip Logic
        async function getAiTip(placeName, desc) {
            // Check for API Key first (Client-side specific)
            if (!apiKey) {
                const modal = document.getElementById('ai-tip-modal');
                const content = document.getElementById('ai-tip-content');
                const textContainer = document.getElementById('ai-tip-text');
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                }, 10);
                
                textContainer.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-lock text-red-400 text-2xl mb-2"></i>
                        <p class="font-bold text-gray-800">API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
                        <p class="text-xs text-gray-500 mt-1">ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ì€ ë³´ì•ˆìƒ API í‚¤ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                        <p class="text-xs text-blue-600 mt-2 cursor-pointer hover:underline" onclick="window.open('https://aistudio.google.com/app/apikey')">
                            Google AI Studioì—ì„œ í‚¤ ë°œê¸‰ë°›ê¸° &rarr;
                        </p>
                        <p class="text-[10px] text-gray-400 mt-2">ì½”ë“œì˜ const apiKey = "" ë¶€ë¶„ì— í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                    </div>`;
                return;
            }

            const modal = document.getElementById('ai-tip-modal');
            const content = document.getElementById('ai-tip-content');
            const textContainer = document.getElementById('ai-tip-text');
            
            // Show Loading
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            textContainer.innerHTML = `
                <div class="flex flex-col items-center">
                    <div class="w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin mb-2"></div>
                    <span>Geminiê°€ ê¿€íŒì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</span>
                </div>`;

            try {
                const prompt = `ê°•ë¦‰ ì—¬í–‰ ì¤‘ '${placeName}'(${desc}) ë°©ë¬¸ ì‹œ, 6ì„¸ ë”¸ì´ ìˆëŠ” ê°€ì¡±ì„ ìœ„í•œ ì§§ê³  ì‹¤ìš©ì ì¸ ê¿€íŒ 1ê°€ì§€ë§Œ ì•Œë ¤ì¤˜. í•œêµ­ì–´ë¡œ 50ì ì´ë‚´. ì´ëª¨ì§€ 1ê°œ í¬í•¨.`;
                const aiResponse = await callGeminiAPI(prompt, "You are a concise travel assistant.");
                textContainer.innerHTML = marked.parse(aiResponse);
            } catch (error) {
                textContainer.innerHTML = `<span class="text-red-500">íŒì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</span>`;
            }
        }

        function closeAiTip() {
            const modal = document.getElementById('ai-tip-modal');
            const content = document.getElementById('ai-tip-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // 6.2 AI Chat Logic
        function toggleChat() {
            const chatInterface = document.getElementById('chat-interface');
            const chatWindow = document.getElementById('chat-window');
            
            if (chatInterface.classList.contains('hidden')) {
                chatInterface.classList.remove('hidden');
                setTimeout(() => {
                    chatWindow.classList.remove('translate-y-full');
                }, 10);
                document.getElementById('chat-input').focus();
            } else {
                chatWindow.classList.add('translate-y-full');
                setTimeout(() => {
                    chatInterface.classList.add('hidden');
                }, 300);
            }
        }

        function handleChatKey(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

             // Check API Key
             if (!apiKey) {
                addMessageToChat("**[ì•ˆë‚´]** API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ë‹µë³€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ë‹¤ìš´ë¡œë“œ íŒŒì¼ì—ì„œëŠ” ë³´ì•ˆìƒ í‚¤ê°€ ì œì™¸ë©ë‹ˆë‹¤.", 'ai');
                input.value = '';
                return;
            }

            // Clear Input
            input.value = '';

            // Add User Message
            addMessageToChat(message, 'user');

            // Add Loading Indicator
            const loadingId = addLoadingIndicator();

            try {
                // Construct Context-Aware Prompt
                const context = JSON.stringify(tripData);
                const systemPrompt = `ë‹¹ì‹ ì€ 2026ë…„ 1ì›” 7ì¼~8ì¼ ê°•ë¦‰ ê°€ì¡± ì—¬í–‰ ì „ë¬¸ AI ê°€ì´ë“œì…ë‹ˆë‹¤.
                ê°€ì¡± êµ¬ì„±ì›: 38ì„¸ ë¶€ë¶€(ë‚¨í¸: ì»¤í”¼ ì„ í˜¸, ì•„ë‚´: í† ì†ìŒì‹/ì‹œì¥ ì„ í˜¸), 6ì„¸ ë”¸(ë™ë¬¼/ì•¡í‹°ë¹„í‹° ì„ í˜¸).
                í˜„ì¬ ì—¬í–‰ ê³„íš ë°ì´í„°(JSON): ${context}
                
                ìœ„ ì—¬í–‰ ë°ì´í„°ë¥¼ ì™„ë²½í•˜ê²Œ ìˆ™ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•´ í˜„ì¬ ê³„íšëœ ì¼ì •ì„ ë°”íƒ•ìœ¼ë¡œ ì¹œì ˆí•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”.
                ì§ˆë¬¸ì— ì—¬í–‰ì§€ê°€ ì–¸ê¸‰ë˜ë©´ í•´ë‹¹ ì—¬í–‰ì§€ì˜ íŠ¹ì§•, ì•„ì´ì™€ í•¨ê»˜í•  ë•Œ ì£¼ì˜í•  ì  ë“±ì„ í¬í•¨í•˜ì„¸ìš”.
                ë‹µë³€ì€ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ê³ , ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì„ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì´ì„¸ìš”.`;

                const aiResponse = await callGeminiAPI(message, systemPrompt);
                
                // Remove loading and add AI response
                removeMessage(loadingId);
                addMessageToChat(aiResponse, 'ai');

            } catch (error) {
                removeMessage(loadingId);
                addMessageToChat("ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", 'ai');
                console.error(error);
            }
        }

        function addMessageToChat(text, sender) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = sender === 'user' ? 'chat-user chat-bubble shadow-sm' : 'chat-ai chat-bubble shadow-sm';
            
            if (sender === 'ai') {
                div.innerHTML = marked.parse(text);
            } else {
                div.textContent = text;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div.id; // Return ID if needed (not used here but good practice)
        }

        function addLoadingIndicator() {
            const container = document.getElementById('chat-messages');
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'chat-ai chat-bubble shadow-sm typing-indicator';
            div.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // --- 7. Core Gemini API Caller ---
        async function callGeminiAPI(userText, systemText) {
            // NOTE: In a real production app, never expose API keys on the client side.
            // This is for demonstration in the Canvas environment where key is injected.
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ 
                    parts: [{ text: userText }] 
                }],
                systemInstruction: {
                    parts: [{ text: systemText }]
                }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // Initialize
        init();

    </script>
</body>
</html>


